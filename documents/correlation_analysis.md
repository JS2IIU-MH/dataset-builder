
# 相関分析 (Correlation Analysis)

## 目的

相関分析は、データ中の2つの変数がどのように関連しているか（主に方向と強さ）を定量的に把握するための手法です。特徴量選択や多重共線性の検出、仮説検証の手がかりになります。

## 何を分析するか

- 主に連続変数間の共変動を調べる。カテゴリ変数はダミー化や別指標が必要。
- 欠損値や外れ値の扱いによって結果が変わるため事前処理が重要。

## 代表的な指標

- **Pearson相関係数**（線形関係の強さ）: 2変数の線形な同時変動を測る。値は $-1$〜$1$ の範囲。

$$
r = \frac{\sum_i (x_i-\bar{x})(y_i-\bar{y})}{\sqrt{\sum_i (x_i-\bar{x})^2 \sum_i (y_i-\bar{y})^2}}
$$

- **Spearman順位相関**：単調関係（非線形を含む）を評価する。順位に基づくため外れ値に対してロバスト。
- 必要に応じて**p値**や信頼区間で統計的有意性を確認する。

## 解釈

- 相関係数 $r$ の絶対値が大きいほど強い相関。正は同方向、負は逆方向を示す。
- 相関は因果を意味しない（相関 ≠ 因果）。共通原因や交絡に注意する。

## 可視化でわかること

- **ヒートマップ**：相関行列を一目で確認し、高相関のペアを見つける。\
- **散布図（散布行列）**：関係の形（線形か非線形か）、外れ値、分布の偏りを直接確認できる。\
- **ペアプロット**：複数変数間の相互関係を俯瞰する際に有用。

## よくある用途

- 多重共線性の検出（説明変数間で高相関がある場合、モデルの安定性低下に注意）
- 重要候補変数の選定や、特徴量エンジニアリング（変換や組み合わせの検討）

## 注意点と対策

- 外れ値は相関を歪める → 散布図で確認して必要なら除外やロバスト手法を検討する。
- 非線形関係はPearsonで低く出る → Spearmanや非線形モデルを検討する。
- サンプルサイズが小さいと相関推定が不安定 → 信頼区間やp値を確認する。
- カテゴリ変数や混合データ型には適切な相関指標を使う（点二列相関、Cramér's Vなど）。

## `src/logic/eda.py` の `corr_matrix` 関数について

`src/logic/eda.py` にある `corr_matrix(df, method='pearson')` 関数は、実際に次の手順で相関係数行列を計算します。

- 数値列の抽出: `df.select_dtypes(include="number")` により、数値型カラムのみを対象にします（文字列やカテゴリ列は除外）。
- 相関計算: Pandas の `DataFrame.corr(method=method)` を呼び出して、列ごとのペアワイズ相関係数を計算します。デフォルトは `method='pearson'`（線形相関）。
- 出力: 各列名をインデックスとカラムに持つ正方行列の `DataFrame` を返します。各セルは -1〜1 の相関係数、計算不能な組合せは `NaN` になります。

主な注意点:

- 欠損値の扱い: 相関はペアごとの有効観測で計算される（pairwise deletion）。片方に欠損がある観測はそのペアの計算から除外されます。
- 定数列やサンプル不足: 変数が一定値のみ（分散ゼロ）や有効観測数が不足すると、相関が計算できず `NaN` になります。
- 手法選択: `method` に `'pearson'`（線形）、`'spearman'`（順位相関、単調関係）、`'kendall'`（順位一致度）を指定可能。

簡単な使用例（Python）:

```py
from src.logic.eda import corr_matrix

cm = corr_matrix(df, method='pearson')
print(cm)
```

この説明を基に、ヒートマップ表示や散布図描画で可視化すると、どの列間に強い線形（または順位）関係があるかを直感的に把握できます。

## 相関ヒートマップの見方（丁寧な解説）

相関ヒートマップは、変数間の相関係数行列を色の強弱で表現した可視化です。以下の点を順に見ていくと、図から得られる情報を正しく解釈できます。

- **色スケールの意味**: 通常カラースケールは負の相関（例えば青）→0（白）→正の相関（例えば赤）といった連続で表されます。色の濃さは相関の絶対値の大きさ（強さ）を示します。具体例: 0.8 は濃い正の色（強い同方向の関係）、-0.6 は濃い負の色（中〜強い逆方向の関係）。

- **対角線（自分自身との相関）**: 対角要素は常に 1（完全相関）になるため、注視する必要はありません。多くの実装では視認性のために対角をマスク（非表示）することがあります。

- **上下三角の重複**: 相関行列は対称なのでヒートマップは上下が重複します。見やすくするため上三角または下三角のみを表示することがよくあります。

- **クラスタリング/順序**: 変数の順序を工夫（階層クラスタリングなど）すると、似た相関パターンを持つ変数群が近くにまとまり、読み取りやすくなります。順序がランダムだと関係性が分かりづらくなります。

- **注釈（数値表示）**: セルに相関係数の数値（例: 0.72）を表示すると、色だけでは判別しづらい中程度の違いを正確に把握できます。ただし多数変数では図が窮屈になるため、フィルタや上位のみ表示する工夫が必要です。

- **有意性の表示**: 相関の大きさだけでなく、サンプルサイズによっては見かけ上の相関が偶然である場合があります。p値や信頼区間を併記するか、有意でないセルを薄く表示するなどの工夫が有用です。

- **NaNや定数列の扱い**: 欠損の多い列や分散ゼロの列は `NaN` を含むセルが表示されます。これらは解釈不能なので事前に確認・処理してください。

- **実務的な読み方（チェックリスト）**:
  - 同じ意味を持つ変数が高相関で重複していないか（特徴量削減の候補）。
  - 説明変数同士で高相関がある場合、回帰モデルで多重共線性の問題を引き起こす可能性を検討する。
  - 想定外に高い相関が見つかったら、外れ値・データ結合エラー・スケールの違いを疑う。

- **読む際の注意（因果について）**: 相関は因果を示さないため、相関の高低だけで「AがBを引き起こす」と結論づけてはいけません。ドメイン知識や追加の解析（時系列解析、介入実験など）で因果仮説を検証してください。

### 図の読み取り例

### 図の読み取り例（汎用的な解釈）

- セル (変数A, 変数B) = 0.75（濃い正の色） → 変数A と変数B に強い同方向の関係がある（片方が大きいともう片方も大きくなる傾向）。ただし因果関係は自動的には示されない。
- セル (変数C, 変数D) = -0.05（薄い色） → ほとんど相関がなく、線形な関係は乏しい。別の説明変数や非線形関係を検討する。
- 複数の説明変数間で 0.9 以上の相関が見られる → 非常に強い相関。モデルでの多重共線性に注意し、変数削減（PCA等）や正則化を検討する。

相関係数の目安（プロジェクト基準に応じて調整してください）:

- |r| ≥ 0.8: 強い相関
- 0.5 ≤ |r| < 0.8: 中程度の相関
- 0.3 ≤ |r| < 0.5: 弱い相関
- |r| < 0.3: ほとんど相関なし

これらの判定はあくまで目安です。図を解釈する際は、サンプル数、p値、有意性、外れ値の有無、変数のスケールや意味（カテゴリか連続か）を必ず確認してください。

### 描画の実装ヒント（簡潔な例）

シンプルなヒートマップ（seaborn）:

```py
import seaborn as sns
import matplotlib.pyplot as plt

cm = corr_matrix(df)
mask = np.triu(np.ones_like(cm, dtype=bool))
plt.figure(figsize=(8,6))
sns.heatmap(cm, mask=mask, annot=True, fmt='.2f', cmap='RdBu_r', vmin=-1, vmax=1)
plt.show()
```
